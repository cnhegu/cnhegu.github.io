# .github/workflows/deploy.yml

name: Deploy Hugo site to GitHub Pages

on:
  push:
    branches:
      - main # ç¡®ä¿è¿™æ˜¯ä½ çš„ä¸»åˆ†æ”¯å
  workflow_dispatch:

# å…³é”®ï¼šä¸ºå·¥ä½œæµè®¾ç½®æƒé™ï¼Œä½¿å…¶å¯ä»¥éƒ¨ç½²åˆ° GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# è®¾ç½®å¹¶å‘æ§åˆ¶ï¼Œç¡®ä¿æ¯æ¬¡åªæœ‰ä¸€ä¸ªéƒ¨ç½²åœ¨è¿è¡Œ
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  # æ„å»ºä»»åŠ¡
  build:
    runs-on: ubuntu-latest
    steps:
      # ç¬¬ 1 æ­¥ï¼šæ£€å‡ºä½ çš„ä»“åº“ä»£ç 
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive # å¦‚æœä½ åŒæ—¶æœ‰å­æ¨¡å—ï¼Œè¿™ä¼šæ‹‰å–å®ƒä»¬
          fetch-depth: 0       # æ‹‰å–æ‰€æœ‰ Git å†å²ï¼ŒæŸäº› Hugo åŠŸèƒ½éœ€è¦

      # ç¬¬ 2 æ­¥ï¼šå®‰è£…æœ€æ–°ç‰ˆçš„ Hugo (Extended ç‰ˆæœ¬)
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3 # ğŸ‘ˆ å‡çº§åˆ°äº† v3 ç‰ˆæœ¬
        with:
          hugo-version: 'latest'
          extended: true

      # ç¬¬ 3 æ­¥ï¼šã€æ ¸å¿ƒä¿®å¤ã€‘ä¸‹è½½å¹¶æ›´æ–° Hugo æ¨¡å— (åŒ…æ‹¬ä½ çš„ä¸»é¢˜)
      # ä¹‹å‰çš„é”™è¯¯å°±æ˜¯å› ä¸ºç¼ºå°‘äº†è¿™ä¸€æ­¥
      - name: Update Hugo Modules
        run: hugo mod get -u # ğŸ‘ˆ è¿™ä¸ªå‘½ä»¤ä¼šä¸‹è½½ go.mod ä¸­å®šä¹‰çš„æ‰€æœ‰æ¨¡å—

      # VVVV æˆ‘ä»¬åœ¨è¿™é‡Œæ·»åŠ äº†è°ƒè¯•æ­¥éª¤ VVVV
      - name: ğŸ•µï¸ Check Content of _index.md
        run: |
          echo "--- Verifying content of _index.md on the runner ---"
          cat ./content/about/_index.md
          echo "--- End of file content ---"
      # ^^^^ è°ƒè¯•æ­¥éª¤ç»“æŸ ^^^^

      # ç¬¬ 4 æ­¥ï¼šæ‰§è¡Œ Hugo æ„å»ºï¼Œç”Ÿæˆç½‘ç«™
      - name: Build with Hugo
        run: hugo --minify # ğŸ‘ˆ ä½¿ç”¨ --minify å‹ç¼©è¾“å‡ºæ–‡ä»¶ï¼Œæå‡ç½‘ç«™é€Ÿåº¦

      # ç¬¬ 5 æ­¥ï¼šé…ç½® GitHub Pages
      - name: Setup Pages
        uses: actions/configure-pages@v5

      # ç¬¬ 6 æ­¥ï¼šå°†æ„å»ºå¥½çš„ç½‘ç«™ (public ç›®å½•) æ‰“åŒ…æˆæ„ä»¶
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # ä» 'public' ç›®å½•ä¸Šä¼ 
          path: ./public

  # éƒ¨ç½²ä»»åŠ¡
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build # ğŸ‘ˆ ä¾èµ–äº 'build' ä»»åŠ¡æˆåŠŸå®Œæˆ
    steps:
      # ç¬¬ 7 æ­¥ï¼šä»æ„ä»¶éƒ¨ç½²åˆ° GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4 # ğŸ‘ˆ ä½¿ç”¨å®˜æ–¹æœ€æ–°çš„éƒ¨ç½² Action